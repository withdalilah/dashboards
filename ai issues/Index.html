<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .card { transition: transform 0.2s; cursor: pointer; }
    .card:hover { transform: translateY(-3px); }
    .chart-container { position: relative; height: 300px; width: 100%; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* Modal Styles */
    #modalOverlay { background-color: rgba(0,0,0,0.5); }
  </style>
</head>
<body class="text-gray-800">

  <nav class="bg-white shadow-md sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        <div class="flex items-center">
          <span class="text-xl font-bold text-blue-600 tracking-tight">AI Issue Analytics</span>
        </div>
        <div class="flex space-x-4">
          <select id="monthFilter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
            <option value="All">All Months</option>
            </select>
          <select id="marketFilter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
            <option value="All">All Markets</option>
            <option value="Dubai">Dubai</option>
            <option value="Portugal">Portugal</option>
            <option value="UK">UK</option>
          </select>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <div id="loading" class="text-center">
      <div class="loader"></div>
      <p class="text-gray-500 mt-2">Loading Dashboard Data...</p>
    </div>

    <div id="dashboard" class="hidden space-y-8">
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white overflow-hidden shadow rounded-lg card p-5 border-l-4 border-blue-500" onclick="showMetricDetails('Dubai')">
          <dt class="text-sm font-medium text-gray-500 truncate">Low Rating: Dubai</dt>
          <dd id="metric-Dubai" class="mt-1 text-3xl font-semibold text-gray-900">0</dd>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg card p-5 border-l-4 border-green-500" onclick="showMetricDetails('Portugal')">
          <dt class="text-sm font-medium text-gray-500 truncate">Low Rating: Portugal</dt>
          <dd id="metric-Portugal" class="mt-1 text-3xl font-semibold text-gray-900">0</dd>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg card p-5 border-l-4 border-red-500" onclick="showMetricDetails('UK')">
          <dt class="text-sm font-medium text-gray-500 truncate">Low Rating: UK</dt>
          <dd id="metric-UK" class="mt-1 text-3xl font-semibold text-gray-900">0</dd>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg card p-5 border-l-4 border-purple-500" onclick="showMetricDetails('All')">
          <dt class="text-sm font-medium text-gray-500 truncate">Low Rating: Global (GR)</dt>
          <dd id="metric-All" class="mt-1 text-3xl font-semibold text-gray-900">0</dd>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <div class="bg-white shadow rounded-lg p-6 col-span-1 lg:col-span-2">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Ticket Volume Over Time</h3>
          <div class="chart-container">
            <canvas id="timelineChart"></canvas>
          </div>
        </div>

        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Ticket Status Distribution</h3>
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
        </div>

        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Incoming Platform Source</h3>
          <div class="chart-container">
            <canvas id="sourceChart"></canvas>
          </div>
        </div>

        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Cases by Category</h3>
          <div class="chart-container">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>

        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Cases by Subcategory</h3>
          <div class="chart-container">
            <canvas id="subcategoryChart"></canvas>
          </div>
        </div>
        
         <div class="bg-white shadow rounded-lg p-6 col-span-1 lg:col-span-2">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Top 5 Repeated Properties (Rating &le; 1)</h3>
          <div class="chart-container">
            <canvas id="propertyChart"></canvas>
          </div>
        </div>

      </div>

      <h2 class="text-2xl font-bold text-gray-800 mt-10 mb-4 border-b pb-2">Special Analysis</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Missing Due Dates (GXO Post-mortem)</h3>
          <div class="chart-container">
            <canvas id="missingDateChart"></canvas>
          </div>
        </div>

        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Tickets Overdue > 30 Days (Active)</h3>
          <div class="chart-container">
            <canvas id="overdueChart"></canvas>
          </div>
        </div>

      </div>
    </div>
  </main>

  <div id="modalOverlay" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
      <div class="p-6 border-b flex justify-between items-center">
        <h3 id="modalTitle" class="text-xl font-semibold text-gray-900">Details</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>
      <div class="p-6 overflow-y-auto flex-1">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Issue ID</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Prop ID</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Office</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Subcategory</th>
            </tr>
          </thead>
          <tbody id="modalBody" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let rawData = [];
    let charts = {}; // Store chart instances

    // Initialization
    window.onload = function() {
      google.script.run.withSuccessHandler(initDashboard).getDashboardData();
    };

    function initDashboard(jsonString) {
      rawData = JSON.parse(jsonString);
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');

      populateMonthFilter();
      setupEventListeners();
      updateDashboard();
    }

    function populateMonthFilter() {
      // Extract unique months from dd/mm/yyyy
      const months = [...new Set(rawData.map(d => {
        if(!d.createdDate) return "";
        const parts = d.createdDate.split('/');
        return parts.length === 3 ? `${parts[1]}/${parts[2]}` : "";
      }).filter(m => m !== ""))];

      const select = document.getElementById('monthFilter');
      months.sort().forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        select.appendChild(opt);
      });
    }

    function setupEventListeners() {
      document.getElementById('monthFilter').addEventListener('change', updateDashboard);
      document.getElementById('marketFilter').addEventListener('change', updateDashboard);
    }

    // --- Core Logic ---

    function getFilteredData() {
      const monthVal = document.getElementById('monthFilter').value;
      const marketVal = document.getElementById('marketFilter').value;

      return rawData.filter(item => {
        // Month Filter Logic
        let monthMatch = true;
        if (monthVal !== "All") {
          const parts = item.createdDate.split('/');
          const itemMonth = parts.length === 3 ? `${parts[1]}/${parts[2]}` : "";
          if (itemMonth !== monthVal) monthMatch = false;
        }
        return monthMatch;
      });
    }

    function updateDashboard() {
      const globalData = getFilteredData(); // Filtered by Month Only first
      const marketVal = document.getElementById('marketFilter').value;
      
      // Update Metric Cards (These respect Market filter implicitly via arguments, or we calculate strictly)
      // Prompt says: Filter bar filters "All dashboard sections".
      // Metric cards have specific definitions (Dubai, Portugal, UK).
      // If Global Filter is "Month: Nov", Metrics show Nov data.
      updateMetricCards(globalData);

      // Update Charts (These respect both Month and Market filters)
      const chartData = globalData.filter(d => {
        if (marketVal === "All") return true;
        return d.country.toLowerCase().includes(marketVal.toLowerCase());
      });

      renderTimeline(globalData, marketVal); // Timeline handles its own grouping
      renderDonut(chartData);
      renderBarCategory(chartData);
      renderBarSubcategory(chartData);
      renderPieSource(chartData);
      renderRepeatedProperties(globalData, marketVal); // Handles logic internally

      // Special Analysis (Prompt: Exclude Closed, specific logic)
      renderSpecialAnalysis(rawData); // Usually global analysis, but can be filtered. Sticking to Prompt "All tickets where..."
    }

    // --- Metric Cards ---
    
    function updateMetricCards(data) {
      // Filter for Rating <= 1
      const lowRated = data.filter(d => d.rating > 0 && d.rating <= 1);
      
      const counts = {
        Dubai: lowRated.filter(d => d.country.includes('Dubai')).length,
        Portugal: lowRated.filter(d => d.country.includes('Portugal')).length,
        UK: lowRated.filter(d => d.country.includes('Kingdom')).length, // "United Kingdom"
        All: lowRated.length
      };

      document.getElementById('metric-Dubai').innerText = counts.Dubai;
      document.getElementById('metric-Portugal').innerText = counts.Portugal;
      document.getElementById('metric-UK').innerText = counts.UK;
      document.getElementById('metric-All').innerText = counts.All;
    }

    function showMetricDetails(market) {
      const monthVal = document.getElementById('monthFilter').value;
      let data = rawData.filter(d => d.rating > 0 && d.rating <= 1);

      if (monthVal !== "All") {
        data = data.filter(d => d.createdDate.includes(monthVal)); // rough match for simplicity or reuse split logic
      }

      if (market !== "All") {
        const search = market === 'UK' ? 'Kingdom' : market;
        data = data.filter(d => d.country.includes(search));
      }
      
      openModal(`${market} - Low Rated Tickets`, data);
    }

    // --- Charts ---

    function destroyChart(id) {
      if (charts[id]) {
        charts[id].destroy();
      }
    }

    function renderTimeline(data, marketFilter) {
      destroyChart('timelineChart');
      // Group by Date
      const dates = {};
      
      data.forEach(d => {
        // Apply market filter visually, but timeline usually compares? 
        // Prompt: "Show ... for each market". Multiline chart.
        const date = d.createdDate;
        if (!date) return;
        
        if (!dates[date]) dates[date] = { Dubai: 0, Portugal: 0, UK: 0, Other: 0 };
        
        if (d.country.includes('Dubai')) dates[date].Dubai++;
        else if (d.country.includes('Portugal')) dates[date].Portugal++;
        else if (d.country.includes('Kingdom')) dates[date].UK++;
        else dates[date].Other++;
      });

      // Sort dates
      const sortedDates = Object.keys(dates).sort((a,b) => {
        const [d1, m1, y1] = a.split('/');
        const [d2, m2, y2] = b.split('/');
        return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
      });

      const ctx = document.getElementById('timelineChart').getContext('2d');
      charts['timelineChart'] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedDates,
          datasets: [
            { label: 'Dubai', data: sortedDates.map(d => dates[d].Dubai), borderColor: '#3b82f6', tension: 0.3 },
            { label: 'Portugal', data: sortedDates.map(d => dates[d].Portugal), borderColor: '#10b981', tension: 0.3 },
            { label: 'UK', data: sortedDates.map(d => dates[d].UK), borderColor: '#ef4444', tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (e, activeEls) => {
            if (activeEls.length > 0) {
              const index = activeEls[0].index;
              const date = sortedDates[index];
              const drillData = data.filter(d => d.createdDate === date);
              openModal(`Tickets on ${date}`, drillData);
            }
          }
        }
      });
    }

    function renderDonut(data) {
      destroyChart('statusChart');
      const counts = {};
      data.forEach(d => {
        const s = d.status || "Unknown";
        counts[s] = (counts[s] || 0) + 1;
      });

      const ctx = document.getElementById('statusChart').getContext('2d');
      charts['statusChart'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(counts),
          datasets: [{
            data: Object.values(counts),
            backgroundColor: ['#60a5fa', '#34d399', '#f87171', '#fbbf24', '#a78bfa']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function renderBarCategory(data) {
      destroyChart('categoryChart');
      const counts = {};
      data.forEach(d => {
        const c = d.category || "Uncategorized";
        counts[c] = (counts[c] || 0) + 1;
      });
      // Sort
      const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10); // Top 10

      const ctx = document.getElementById('categoryChart').getContext('2d');
      charts['categoryChart'] = new Chart(ctx, {
        type: 'bar',
        indexAxis: 'y',
        data: {
          labels: sorted.map(i => i[0]),
          datasets: [{
            label: 'Cases',
            data: sorted.map(i => i[1]),
            backgroundColor: '#818cf8'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function renderBarSubcategory(data) {
      destroyChart('subcategoryChart');
      const counts = {};
      data.forEach(d => {
        const c = d.subcategory || "Uncategorized";
        counts[c] = (counts[c] || 0) + 1;
      });
      const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10); 

      const ctx = document.getElementById('subcategoryChart').getContext('2d');
      charts['subcategoryChart'] = new Chart(ctx, {
        type: 'bar',
        indexAxis: 'y',
        data: {
          labels: sorted.map(i => i[0]),
          datasets: [{
            label: 'Cases',
            data: sorted.map(i => i[1]),
            backgroundColor: '#fbbf24'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function renderPieSource(data) {
      destroyChart('sourceChart');
      const counts = {};
      data.forEach(d => {
        const p = d.platform === "Null" ? "Null" : d.platform;
        counts[p] = (counts[p] || 0) + 1;
      });

      const ctx = document.getElementById('sourceChart').getContext('2d');
      charts['sourceChart'] = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(counts),
          datasets: [{
            data: Object.values(counts),
            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (e, activeEls) => {
            if (activeEls.length > 0) {
              const index = activeEls[0].index;
              const platform = Object.keys(counts)[index];
              const drillData = data.filter(d => (d.platform || "Null") === platform);
              openModal(`Platform: ${platform}`, drillData);
            }
          }
        }
      });
    }

    function renderRepeatedProperties(data, market) {
      destroyChart('propertyChart');
      // Filter Rating <= 1
      let relevant = data.filter(d => d.rating > 0 && d.rating <= 1);
      
      if (market !== "All") {
        relevant = relevant.filter(d => d.country.toLowerCase().includes(market.toLowerCase()));
      }

      const counts = {};
      relevant.forEach(d => {
        const key = `${d.propertyId} (${d.country})`; // Unique key
        counts[key] = (counts[key] || 0) + 1;
      });

      const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);

      const ctx = document.getElementById('propertyChart').getContext('2d');
      charts['propertyChart'] = new Chart(ctx, {
        type: 'bar',
        indexAxis: 'y',
        data: {
          labels: sorted.map(s => s[0]),
          datasets: [{
            label: 'Repeated Issues',
            data: sorted.map(s => s[1]),
            backgroundColor: '#ef4444'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // --- Special Analysis ---

    function renderSpecialAnalysis(allData) {
      // 1. Missing Due Date
      destroyChart('missingDateChart');
      // Filter: AD = Global GXO... AND Due Date is empty AND Not Closed (usually implied in active mgmt, but prompt says Exclude Closed for overdue chart. I'll exclude CLOSED here too for safety or stick to prompt literally).
      // Prompt Chart 7: Exclude CLOSED.
      const missingData = allData.filter(d => 
        d.requestedBy === "Global GXO - Reviews Post-mortem" && 
        !d.dueDate && 
        d.status !== "CLOSED"
      );
      
      // Just a count pie chart? Or grouped by market? Prompt says "Count all...". A single number isn't a chart.
      // Usually "By Market" is implied for dashboard breakdown. I will group by Market.
      const missingCounts = {};
      missingData.forEach(d => {
        const c = d.country || "Unknown";
        missingCounts[c] = (missingCounts[c] || 0) + 1;
      });

      new Chart(document.getElementById('missingDateChart'), {
        type: 'pie',
        data: {
          labels: Object.keys(missingCounts),
          datasets: [{ data: Object.values(missingCounts), backgroundColor: ['#ec4899', '#8b5cf6', '#6366f1'] }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      // 2. Overdue > 30 Days
      destroyChart('overdueChart');
      // Parse dates relative to Today.
      const today = new Date();
      const overdueData = allData.filter(d => {
        if (d.status === "CLOSED" || !d.dueDate) return false;
        
        // Parse dd/mm/yyyy
        const parts = d.dueDate.split('/');
        if (parts.length !== 3) return false;
        const dueObj = new Date(parts[2], parts[1]-1, parts[0]); // Y, M-1, D
        
        const diffTime = Math.abs(today - dueObj);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        // Check if past due
        return (today > dueObj) && (diffDays > 30);
      });

      const odCounts = { Dubai: 0, Portugal: 0, UK: 0, Total: 0 };
      overdueData.forEach(d => {
        odCounts.Total++;
        if (d.country.includes('Dubai')) odCounts.Dubai++;
        else if (d.country.includes('Portugal')) odCounts.Portugal++;
        else if (d.country.includes('Kingdom')) odCounts.UK++;
      });

      new Chart(document.getElementById('overdueChart'), {
        type: 'bar',
        data: {
          labels: ['Dubai', 'Portugal', 'UK', 'Total'],
          datasets: [{
            label: 'Overdue > 30 Days',
            data: [odCounts.Dubai, odCounts.Portugal, odCounts.UK, odCounts.Total],
            backgroundColor: ['#3b82f6', '#10b981', '#ef4444', '#6b7280']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // --- Modal Logic ---

    function openModal(title, dataList) {
      document.getElementById('modalTitle').innerText = title;
      const tbody = document.getElementById('modalBody');
      tbody.innerHTML = '';

      if (dataList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No records found.</td></tr>';
      } else {
        dataList.forEach(item => {
          const row = `
            <tr>
              <td class="px-3 py-2 text-sm text-gray-900">${item.id}</td>
              <td class="px-3 py-2 text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">${item.status}</span></td>
              <td class="px-3 py-2 text-sm text-gray-500">${item.propertyId}</td>
              <td class="px-3 py-2 text-sm text-gray-500">${item.office}</td>
              <td class="px-3 py-2 text-sm text-gray-500">${item.category}</td>
              <td class="px-3 py-2 text-sm text-gray-500">${item.subcategory}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      document.getElementById('modalOverlay').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.add('hidden');
    }
  </script>
</body>
</html>