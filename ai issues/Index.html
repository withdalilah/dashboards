<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* --- STRICT PALETTE --- 
               Blue: #8BA8E3
               Beige: #F3F4E3
               Coral: #F58F79
               GreyBlue: #DBDFEC
               Pink: #FFEAE5
            */

            --primary-bg: #8BA8E3;      
            --primary-font: #5A6B8C;    
            --header-text: #8BA8E3;     
            
            --card-bg: #FFFFFF;         
            --body-bg: #F3F4E3;         
            --border-radius: 12px;
            
            /* Highlight Colors */
            --highlight-row-bg: #FFEAE5; 
            --highlight-chart: #F58F79;  
            --dimmed-chart: #DBDFEC;     
            --filter-tag-bg: #DBDFEC;    
            --border-color: #DBDFEC;
            --tag-bg: #F0F4FA;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--body-bg);
            margin: 0;
            padding: 20px;
            padding-bottom: 100px;
            color: #444; 
        }

        /* --- Header --- */
        .main-header {
            background-color: var(--card-bg); padding: 20px; border-radius: var(--border-radius);
            margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px;
            box-shadow: 0 4px 15px rgba(139, 168, 227, 0.15);
        }
        .main-header h1 { margin: 0; font-size: 1.8em; color: var(--header-text); }
        .main-header p { margin: 5px 0 0; color: #888; font-size: 0.9em; }

        .controls { display: flex; gap: 10px; }
        select {
            padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--body-bg); color: #555; font-family: inherit; cursor: pointer;
            outline: none;
        }
        select:focus { border-color: var(--primary-bg); }

        /* --- KPI Cards --- */
        .kpi-container { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 20px; }
        .kpi-card {
            background-color: var(--card-bg); border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02); padding: 16px; flex: 1 1 150px;
            display: flex; flex-direction: column; justify-content: space-between; min-width: 140px;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; 
            border: 1px solid transparent;
        }
        .kpi-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 16px rgba(139, 168, 227, 0.2); 
            border-color: var(--primary-bg);
        } 

        .kpi-card h3 { margin: 0 0 10px 0; font-size: 0.85em; text-transform: uppercase; color: #999; letter-spacing: 0.5px;}
        .kpi-card .value-container { display: flex; justify-content: space-between; align-items: flex-end; }
        .kpi-card .result { font-size: 1.8em; font-weight: 700; color: #444; }
        .kpi-card .icon { font-size: 1.5em; color: var(--primary-bg); opacity: 0.8; }

        /* --- Charts Grid --- */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .chart-card {
            background-color: var(--card-bg); padding: 16px; border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02); min-height: 350px; position: relative;
        }
        .span-2 { grid-column: span 2; }
        .span-3 { grid-column: span 3; }
        
        .section-title {
            grid-column: span 3; margin: 30px 0 15px 0; 
            font-size: 1.2em; font-weight: 600; color: var(--header-text); 
            border-bottom: 2px solid var(--border-color); padding-bottom: 10px;
            display: flex; align-items: center; gap: 10px;
        }

        .badge {
            font-size: 0.75em; padding: 4px 8px; border-radius: 6px; 
            background-color: var(--tag-bg); color: var(--primary-font);
            font-weight: 600; text-transform: uppercase; float: right;
        }

        /* --- Floating Bottom Drawer (Replaces Modal) --- */
        .case-drawer {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 500px;
            background-color: white;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            border-top-left-radius: 16px; border-top-right-radius: 16px;
            z-index: 900;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }

        .case-drawer.open { transform: translateY(0); }

        .drawer-header {
            padding: 15px 24px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background-color: #FAFAFA; border-top-left-radius: 16px; border-top-right-radius: 16px;
        }
        
        .drawer-content { flex-grow: 1; overflow-y: auto; padding: 0; }

        .drawer-toggle-btn {
            position: fixed; bottom: 24px; right: 24px;
            background-color: var(--primary-bg); color: white;
            border: none; border-radius: 50px; padding: 14px 28px;
            font-size: 1em; font-weight: 600;
            box-shadow: 0 4px 12px rgba(139, 168, 227, 0.5);
            cursor: pointer; z-index: 950;
            display: flex; align-items: center; gap: 10px;
            transition: all 0.2s;
        }
        .drawer-toggle-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(139, 168, 227, 0.6); }
        .drawer-toggle-btn.hidden { display: none; }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { text-align: left; padding: 14px 24px; background-color: white; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border-color); font-weight: 600; color: var(--header-text); }
        td { padding: 12px 24px; border-bottom: 1px solid var(--border-color); color: #555; vertical-align: top; }
        
        tbody tr:hover { background-color: #f9f9f9; }

        /* Responsive */
        @media (max-width: 1024px) { 
            .dashboard-grid { grid-template-columns: 1fr 1fr; } 
            .span-2, .span-3, .section-title { grid-column: span 2; } 
        }
        @media (max-width: 768px) { 
            .dashboard-grid { display: flex; flex-direction: column; } 
            .section-title { grid-column: span 1; }
        }

        /* Loader */
        .loader-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-bg); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader-wrapper" class="loader-container"><div class="loader"></div></div>

    <div id="dashboard-content" style="visibility: hidden;">
        <div class="main-header">
            <div>
                <h1><i class="fa-solid fa-robot"></i> AI Issue Analytics</h1>
                <p>Performance & Issue Tracking Dashboard</p>
            </div>
            <div class="controls">
                <select id="monthFilter"><option value="All">All Months</option></select>
                <select id="marketFilter">
                    <option value="All">All Markets</option>
                    <option value="Dubai">Dubai</option>
                    <option value="Portugal">Portugal</option>
                    <option value="UK">UK</option>
                </select>
            </div>
        </div>

        <div class="kpi-container">
            <div class="kpi-card" onclick="handleCardClick('Dubai')">
                <h3>Low Rating: Dubai</h3>
                <div class="value-container"><span id="metric-Dubai" class="result">0</span><i class="fa-solid fa-star-half-stroke icon"></i></div>
            </div>
            <div class="kpi-card" onclick="handleCardClick('Portugal')">
                <h3>Low Rating: Portugal</h3>
                <div class="value-container"><span id="metric-Portugal" class="result">0</span><i class="fa-solid fa-star-half-stroke icon"></i></div>
            </div>
            <div class="kpi-card" onclick="handleCardClick('UK')">
                <h3>Low Rating: UK</h3>
                <div class="value-container"><span id="metric-UK" class="result">0</span><i class="fa-solid fa-star-half-stroke icon"></i></div>
            </div>
            <div class="kpi-card" onclick="handleCardClick('All')">
                <h3>Low Rating: Global</h3>
                <div class="value-container"><span id="metric-All" class="result">0</span><i class="fa-solid fa-globe icon"></i></div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="chart-card span-2">
                <span class="badge">Parent Only</span>
                <div id="chartTimeline"></div>
            </div>
            <div class="chart-card span-1">
                <span class="badge">Parent Only</span>
                <div id="chartStatus"></div>
            </div>

            <div class="chart-card span-1">
                <span class="badge">Parent Only</span>
                <div id="chartSource"></div>
            </div>
            <div class="chart-card span-1">
                <span class="badge" style="background:#FFEAE5; color:#F58F79;">Child Only</span>
                <div id="chartCategory"></div>
            </div>
            <div class="chart-card span-1">
                 <span class="badge" style="background:#FFEAE5; color:#F58F79;">Child Only</span>
                <div id="chartSubcategory"></div>
            </div>

            <div class="chart-card span-3">
                <span class="badge">Parent Only</span>
                <div id="chartRepeated"></div>
            </div>

            <div class="section-title"><i class="fa-solid fa-magnifying-glass-chart"></i> Special Analysis</div>

            <div class="chart-card span-1"><div id="chartMissing"></div></div>
            <div class="chart-card span-2"><div id="chartOverdue"></div></div>
        </div>
    </div>

    <button id="drawer-btn" class="drawer-toggle-btn hidden" onclick="toggleDrawer()">
        <i class="fa-solid fa-list-ul"></i> View Details
    </button>

    <div id="case-drawer" class="case-drawer">
        <div class="drawer-header">
            <div>
                <h3 style="margin:0; color: var(--header-text);" id="drawer-title">Details</h3>
                <small id="drawer-count" style="color:#888;"></small>
            </div>
            <button onclick="toggleDrawer()" style="background:none; border:none; font-size:1.2em; cursor:pointer; color:#666;"><i class="fa-solid fa-chevron-down"></i></button>
        </div>
        <div class="drawer-content">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>ID</th><th>Status</th><th>Prop ID</th><th>Office</th><th>Category</th><th>Subcategory</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

<script>
    // --- Configuration ---
    // Strict Palette matching your request
    const COLORS = {
        PALETTE: ['#8BA8E3', '#F58F79', '#DBDFEC', '#9AB6ED', '#FAB0A0'],
        BLUE: '#8BA8E3',
        CORAL: '#F58F79',
        GREY: '#DBDFEC',
        BEIGE: '#F3F4E3'
    };
    const FONT_FAMILY = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

    let rawData = [];
    let charts = {}; 

    document.addEventListener('DOMContentLoaded', function() {
        google.script.run.withSuccessHandler(initDashboard).withFailureHandler(showError).getDashboardData();
    });

    function showError(err) {
        document.getElementById('loader-wrapper').style.display = 'none';
        alert("Error: " + err.message);
    }

    function initDashboard(jsonString) {
        rawData = JSON.parse(jsonString);
        document.getElementById('loader-wrapper').style.display = 'none';
        document.getElementById('dashboard-content').style.visibility = 'visible';

        populateMonthFilter();
        setupEventListeners();
        renderDashboard();
    }

    function populateMonthFilter() {
        const months = [...new Set(rawData.map(d => {
            if(!d.createdDate) return "";
            const parts = d.createdDate.split('/');
            return parts.length === 3 ? `${parts[1]}/${parts[2]}` : "";
        }).filter(m => m !== ""))].sort();

        const select = document.getElementById('monthFilter');
        months.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            select.appendChild(opt);
        });
    }

    function setupEventListeners() {
        document.getElementById('monthFilter').addEventListener('change', renderDashboard);
        document.getElementById('marketFilter').addEventListener('change', renderDashboard);
    }

    // --- Core Logic ---

    function getFilteredData() {
        const monthVal = document.getElementById('monthFilter').value;
        return rawData.filter(item => {
            if (monthVal === "All") return true;
            const parts = item.createdDate.split('/');
            const itemMonth = parts.length === 3 ? `${parts[1]}/${parts[2]}` : "";
            return itemMonth === monthVal;
        });
    }

    function renderDashboard() {
        const globalData = getFilteredData(); 
        const marketVal = document.getElementById('marketFilter').value;
        
        // Market filtering helper
        const marketFilterFn = (d) => {
            if (marketVal === "All") return true;
            return d.country.toLowerCase().includes(marketVal.toLowerCase()) || 
                   (marketVal === 'UK' && d.country.toLowerCase().includes('kingdom'));
        };

        const chartData = globalData.filter(marketFilterFn);

        // Segregate Parent vs Child
        const parentDataGlobal = globalData.filter(d => d.issueType === 'PARENT');
        const parentDataChart = chartData.filter(d => d.issueType === 'PARENT');
        const childDataChart = chartData.filter(d => d.issueType !== 'PARENT');

        updateMetrics(parentDataGlobal);

        // Render Charts using ApexCharts
        renderTimeline(parentDataGlobal, marketVal); 
        renderDonut(parentDataChart);
        renderBar(childDataChart, 'category', 'chartCategory', 'Cases by Category', COLORS.BLUE);
        renderBar(childDataChart, 'subcategory', 'chartSubcategory', 'Cases by Subcategory', COLORS.CORAL);
        renderPie(parentDataChart);
        renderRepeated(parentDataGlobal, marketVal);
        renderSpecial(rawData); 
    }

    // --- Metric Cards ---
    function updateMetrics(parentData) {
        const lowRated = parentData.filter(d => d.rating > 0 && d.rating <= 1);
        
        const counts = {
            Dubai: lowRated.filter(d => d.country.includes('Dubai')).length,
            Portugal: lowRated.filter(d => d.country.includes('Portugal')).length,
            UK: lowRated.filter(d => d.country.includes('Kingdom')).length,
            All: lowRated.length
        };

        ['Dubai', 'Portugal', 'UK', 'All'].forEach(k => {
            const el = document.getElementById(`metric-${k}`);
            if(el) el.innerText = counts[k];
        });
    }

    function handleCardClick(market) {
        const monthVal = document.getElementById('monthFilter').value;
        let data = rawData.filter(d => d.issueType === 'PARENT' && d.rating > 0 && d.rating <= 1);

        if (monthVal !== "All") {
             data = data.filter(d => d.createdDate && d.createdDate.includes(monthVal));
        }

        if (market !== "All") {
            const search = market === 'UK' ? 'Kingdom' : market;
            data = data.filter(d => d.country.includes(search));
        }
        
        openDrawer(`${market} - Low Rated Parent Tickets`, data);
    }

    // --- ApexCharts Implementations ---

    function renderTimeline(data, marketFilter) {
        const dates = {};
        // Filter Parent inside aggregator just in case
        data.forEach(d => {
            if(d.issueType !== 'PARENT') return;
            const date = d.createdDate; 
            if(!date) return;
            if(!dates[date]) dates[date] = { Dubai: 0, Portugal: 0, UK: 0 };
            
            if(d.country.includes('Dubai')) dates[date].Dubai++;
            else if(d.country.includes('Portugal')) dates[date].Portugal++;
            else if(d.country.includes('Kingdom')) dates[date].UK++;
        });

        const sortedDates = Object.keys(dates).sort((a,b) => {
            const [d1, m1, y1] = a.split('/');
            const [d2, m2, y2] = b.split('/');
            return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
        });

        const series = [];
        if (marketFilter === 'All' || marketFilter === 'Dubai') 
            series.push({ name: 'Dubai', data: sortedDates.map(d => dates[d].Dubai) });
        if (marketFilter === 'All' || marketFilter === 'Portugal') 
            series.push({ name: 'Portugal', data: sortedDates.map(d => dates[d].Portugal) });
        if (marketFilter === 'All' || marketFilter === 'UK') 
            series.push({ name: 'UK', data: sortedDates.map(d => dates[d].UK) });

        const options = {
            series: series,
            chart: { 
                type: 'area', height: 320, fontFamily: FONT_FAMILY, toolbar: { show: false },
                events: {
                    markerClick: function(event, chartContext, { seriesIndex, dataPointIndex }) {
                        const date = sortedDates[dataPointIndex];
                        const drillData = data.filter(d => d.createdDate === date && d.issueType === 'PARENT');
                        openDrawer(`Tickets on ${date}`, drillData);
                    }
                }
            },
            colors: [COLORS.BLUE, COLORS.CORAL, '#9AB6ED'],
            stroke: { curve: 'smooth', width: 2 },
            fill: { type: 'gradient', gradient: { opacityFrom: 0.6, opacityTo: 0.1 } },
            xaxis: { categories: sortedDates },
            title: { text: 'Parent Ticket Volume Over Time', style: { color: COLORS.BLUE, fontSize: '16px' } }
        };

        if(charts['timeline']) charts['timeline'].destroy();
        charts['timeline'] = new ApexCharts(document.querySelector("#chartTimeline"), options);
        charts['timeline'].render();
    }

    function renderDonut(data) {
        const counts = {};
        data.forEach(d => { counts[d.status || 'Unknown'] = (counts[d.status || 'Unknown'] || 0) + 1; });
        
        const options = {
            series: Object.values(counts),
            labels: Object.keys(counts),
            chart: { 
                type: 'donut', height: 320, fontFamily: FONT_FAMILY,
                events: {
                    dataPointSelection: (e, chart, config) => {
                        const idx = config.selectedDataPoints[0][0];
                        if (idx !== undefined && idx !== -1) {
                            const label = config.w.config.labels[idx];
                            const drill = data.filter(d => (d.status || "Unknown") === label);
                            openDrawer(`Status: ${label}`, drill);
                        }
                    }
                }
            },
            colors: COLORS.PALETTE,
            title: { text: 'Ticket Status Distribution', style: { color: COLORS.BLUE, fontSize: '16px' } }
        };

        if(charts['status']) charts['status'].destroy();
        charts['status'] = new ApexCharts(document.querySelector("#chartStatus"), options);
        charts['status'].render();
    }

    function renderBar(data, field, elId, title, color) {
        const counts = {};
        data.forEach(d => { 
            const val = d[field] || 'Uncategorized';
            counts[val] = (counts[val] || 0) + 1; 
        });
        
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10);
        
        const options = {
            series: [{ name: 'Cases', data: sorted.map(i => i[1]) }],
            chart: { 
                type: 'bar', height: 320, fontFamily: FONT_FAMILY, toolbar: { show: false },
                events: {
                    dataPointSelection: (e, chart, config) => {
                        const idx = config.selectedDataPoints[0][0];
                        if (idx !== undefined && idx !== -1) {
                            const label = config.w.config.xaxis.categories[idx];
                            const drill = data.filter(d => (d[field] || "Uncategorized") === label);
                            openDrawer(`${title}: ${label}`, drill);
                        }
                    }
                }
            },
            plotOptions: { bar: { borderRadius: 4, horizontal: true, barHeight: '60%' } },
            colors: [color],
            xaxis: { categories: sorted.map(i => i[0]) },
            title: { text: title, style: { color: COLORS.BLUE, fontSize: '16px' } }
        };

        if(charts[elId]) charts[elId].destroy();
        charts[elId] = new ApexCharts(document.querySelector(`#${elId}`), options);
        charts[elId].render();
    }

    function renderPie(data) {
        const counts = {};
        data.forEach(d => { 
            const p = (d.platform === "Null" || !d.platform) ? "Null" : d.platform;
            counts[p] = (counts[p] || 0) + 1; 
        });

        const options = {
            series: Object.values(counts),
            labels: Object.keys(counts),
            chart: { 
                type: 'pie', height: 320, fontFamily: FONT_FAMILY,
                events: {
                    dataPointSelection: (e, chart, config) => {
                        const idx = config.selectedDataPoints[0][0];
                        if (idx !== undefined && idx !== -1) {
                            const label = config.w.config.labels[idx];
                            const drill = data.filter(d => (d.platform || "Null") === label);
                            openDrawer(`Source: ${label}`, drill);
                        }
                    }
                }
            },
            colors: COLORS.PALETTE,
            title: { text: 'Incoming Sources', style: { color: COLORS.BLUE, fontSize: '16px' } }
        };

        if(charts['source']) charts['source'].destroy();
        charts['source'] = new ApexCharts(document.querySelector("#chartSource"), options);
        charts['source'].render();
    }

    function renderRepeated(data, market) {
        let relevant = data.filter(d => d.rating > 0 && d.rating <= 1);
        if (market !== "All") relevant = relevant.filter(d => d.country.toLowerCase().includes(market.toLowerCase()) || (market==='UK' && d.country.toLowerCase().includes('kingdom')));

        const counts = {};
        relevant.forEach(d => {
            const key = `${d.propertyId} (${d.country})`;
            counts[key] = (counts[key] || 0) + 1;
        });
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);

        const options = {
            series: [{ name: 'Repeats', data: sorted.map(s => s[1]) }],
            chart: { 
                type: 'bar', height: 320, fontFamily: FONT_FAMILY, toolbar: { show: false },
                events: {
                    dataPointSelection: (e, chart, config) => {
                        const idx = config.selectedDataPoints[0][0];
                        if (idx !== undefined && idx !== -1) {
                            const label = config.w.config.xaxis.categories[idx];
                            const drill = relevant.filter(d => `${d.propertyId} (${d.country})` === label);
                            openDrawer(`Repeated: ${label}`, drill);
                        }
                    }
                }
            },
            colors: [COLORS.CORAL],
            plotOptions: { bar: { borderRadius: 4, horizontal: false, columnWidth: '40%' } },
            xaxis: { categories: sorted.map(s => s[0]) },
            title: { text: 'Top Repeated Properties (Rating â‰¤ 1)', style: { color: COLORS.BLUE, fontSize: '16px' } }
        };

        if(charts['repeated']) charts['repeated'].destroy();
        charts['repeated'] = new ApexCharts(document.querySelector("#chartRepeated"), options);
        charts['repeated'].render();
    }

    function renderSpecial(allData) {
        // 1. Missing Due Date (GXO) - Pie
        const missing = allData.filter(d => 
            d.issueType === 'PARENT' &&
            d.requestedBy === "Global GXO - Reviews Post-mortem" && 
            !d.dueDate && d.status !== "CLOSED"
        );
        const mCounts = {};
        missing.forEach(d => { mCounts[d.country] = (mCounts[d.country] || 0) + 1; });

        const opt1 = {
            series: Object.values(mCounts), labels: Object.keys(mCounts),
            chart: { type: 'pie', height: 300, fontFamily: FONT_FAMILY },
            colors: COLORS.PALETTE,
            title: { text: 'Missing Due Dates (GXO)', style: { color: COLORS.BLUE, fontSize: '14px' } }
        };
        if(charts['missing']) charts['missing'].destroy();
        charts['missing'] = new ApexCharts(document.querySelector("#chartMissing"), opt1);
        charts['missing'].render();

        // 2. Overdue > 30 Days - Bar
        const today = new Date();
        const overdue = allData.filter(d => {
            if (d.issueType !== 'PARENT' || d.status === "CLOSED" || !d.dueDate) return false;
            const parts = d.dueDate.split('/');
            if (parts.length !== 3) return false;
            const dueObj = new Date(parts[2], parts[1]-1, parts[0]);
            const diffDays = Math.ceil((today - dueObj) / (1000 * 60 * 60 * 24));
            return (today > dueObj) && (diffDays > 30);
        });

        const odCounts = { Dubai: 0, Portugal: 0, UK: 0, Total: 0 };
        overdue.forEach(d => {
            odCounts.Total++;
            if (d.country.includes('Dubai')) odCounts.Dubai++;
            else if (d.country.includes('Portugal')) odCounts.Portugal++;
            else if (d.country.includes('Kingdom')) odCounts.UK++;
        });

        const opt2 = {
            series: [{ name: 'Overdue', data: [odCounts.Dubai, odCounts.Portugal, odCounts.UK, odCounts.Total] }],
            chart: { type: 'bar', height: 300, fontFamily: FONT_FAMILY, toolbar:{show:false} },
            colors: [COLORS.CORAL],
            xaxis: { categories: ['Dubai', 'Portugal', 'UK', 'Total'] },
            title: { text: 'Tickets Overdue > 30 Days', style: { color: COLORS.BLUE, fontSize: '14px' } }
        };
        if(charts['overdue']) charts['overdue'].destroy();
        charts['overdue'] = new ApexCharts(document.querySelector("#chartOverdue"), opt2);
        charts['overdue'].render();
    }

    // --- Drawer Logic ---

    function openDrawer(title, list) {
        document.getElementById('drawer-title').innerText = title;
        document.getElementById('drawer-count').innerText = `(${list.length} items)`;
        
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        if(list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#888;">No records found.</td></tr>';
        } else {
            list.slice(0, 100).forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${item.id}</strong></td>
                    <td><span style="background:${COLORS.GREY}; padding:2px 8px; border-radius:12px; font-size:0.85em;">${item.status}</span></td>
                    <td>${item.propertyId}</td>
                    <td>${item.office}</td>
                    <td>${item.category}</td>
                    <td>${item.subcategory}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        const drawer = document.getElementById('case-drawer');
        const btn = document.getElementById('drawer-btn');
        if (!drawer.classList.contains('open')) {
            drawer.classList.add('open');
            btn.classList.add('hidden');
        }
    }

    function toggleDrawer() {
        const drawer = document.getElementById('case-drawer');
        const btn = document.getElementById('drawer-btn');
        const isOpen = drawer.classList.toggle('open');
        if (isOpen) btn.classList.add('hidden'); else btn.classList.remove('hidden');
    }

</script>
</body>
</html>